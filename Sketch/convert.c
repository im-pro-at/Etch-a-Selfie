/*
  Etch-a-Selfie
  Copyright (c) 2019 Patrick Kn√∂bel
*/

#include <math.h>
#include <stddef.h>
#include <stdlib.h>

#include <esp_attr.h>

#include "convert.h"

#define MAX(a,b) (((a)>(b))?(a):(b))

typedef struct 
{
   uint16_t xs;
   uint16_t ys;
   uint16_t xe;
   uint16_t ye;
} s_line;

static DRAM_ATTR float tanhlookuptable[]={0,0.00195312251647692,0.00390623013190634,0.00585930794569548,0.00781234105816101,0.00976531457098372,0.011718213587663,0.0136710232139714,0.0156237285584089,0.0175763147326568,0.019528766852032,0.0214810700359405,0.0234332094083307,0.0253851700981467,0.0273369372397811,0.0292884959735271,0.0312398314460313,0.0331909288107443,0.0351417732283728,0.0370923498673301,0.0390426439041859,0.0409926405241168,0.0429423249213546,0.0448916822996356,0.0468406978726481,0.0487893568644798,0.0507376445100646,0.0526855460556284,0.0546330467591343,0.0565801318907272,0.0585267867331772,0.0604729965823228,0.0624187467475125,0.0643640225520465,0.0663088093336163,0.0682530924447445,0.0701968572532231,0.0721400891425505,0.0740827735123683,0.0760248957788967,0.0779664413753682,0.0799073957524615,0.081847744378733,0.083787472741048,0.0857265663450104,0.0876650107153913,0.0896027913965563,0.0915398939528913,0.0934763039692277,0.0954120070512659,0.0973469888259969,0.0992812349421238,0.101214731070481,0.103147462904451,0.105079416160384,0.107010576578011,0.108940929920855,0.110870461976648,0.112799158557739,0.114727005501503,0.116653988670749,0.118580093954125,0.120505307266525,0.122429614549487,0.124353001771596,0.126275454928887,0.128196960045235,0.130117503172757,0.132037070392203,0.133955647813349,0.135873221575387,0.137789777847312,0.139705302828314,0.141619782748156,0.143533203867559,0.145445552478587,0.147356814905019,0.149266977502733,0.151176026660076,0.153083948798237,0.154990730371624,0.156896357868223,0.158800817809974,0.160704096753131,0.162606181288627,0.164507058042429,0.166406713675906,0.168305134886175,0.170202308406462,0.172098221006451,0.173992859492633,0.175886210708655,0.177778261535664,0.179668998892649,0.181558409736785,0.183446481063764,0.18533319990814,0.187218553343654,0.189102528483571,0.190985112481006,0.192866292529251,0.194746055862097,0.196624389754159,0.198501281521192,0.20037671852041,0.202250688150796,0.20412317785342,0.20599417511174,0.207863667451917,0.209731642443112,0.211598087697791,0.213462990872025,0.215326339665783,0.217188121823228,0.219048325133005,0.220906937428537,0.222763946588302,0.224619340536122,0.226473107241441,0.228325234719604,0.230175711032133,0.232024524286999,0.23387166263889,0.235717114289482,0.2375608674877,0.239402910529983,0.241243231760541,0.24308181957161,0.244918662403709,0.24675374874589,0.248587067135984,0.250418606160848,0.252248354456607,0.254076300708894,0.255902433653086,0.257726742074542,0.259549214808827,0.261369840741947,0.263188608810573,0.265005508002263,0.26682052735568,0.268633655960815,0.270444882959196,0.2722541975441,0.274061588960766,0.275867046506596,0.277670559531358,0.279472117437391,0.281271709679796,0.283069325766634,0.284864955259116,0.286658587771793,0.288450212972739,0.290239820583737,0.292027400380454,0.293812942192625,0.295596435904221,0.297377871453621,0.299157238833785,0.300934528092412,0.302709729332109,0.304482832710546,0.306253828440617,0.308022706790589,0.309789458084255,0.311554072701085,0.313316541076364,0.315076853701341,0.316835001123366,0.318590973946024,0.320344762829271,0.322096358489564,0.323845751699988,0.325592933290384,0.327337894147465,0.32908062521494,0.330821117493628,0.332559362041572,0.334295349974148,0.336029072464175,0.337760520742017,0.339489686095688,0.341216559870946,0.342941133471395,0.344663398358572,0.346383346052044,0.348100968129489,0.349816256226787,0.351529202038095,0.353239797315933,0.354948033871255,0.356653903573524,0.358357398350786,0.360058510189731,0.361757231135764,0.363453553293066,0.365147468824648,0.366838969952418,0.368528048957226,0.370214698178918,0.371898910016385,0.37358067692761,0.375259991429709,0.376936846098969,0.378611233570892,0.380283146540223,0.381952577760987,0.383619520046514,0.385283966269472,0.386945909361885,0.388605342315157,0.390262258180091,0.391916650066905,0.393568511145245,0.395217834644196,0.396864613852291,0.398508842117517,0.400150512847315,0.401789619508586,0.403426155627683,0.405060114790411,0.406691490642018,0.408320276887186,0.409946467290017,0.411570055674022,0.413191035922101,0.414809401976522,0.416425147838904,0.418038267570187,0.419648755290608,0.421256605179674,0.422861811476122,0.424464368477894,0.426064270542094,0.427661512084954,0.429256087581787,0.430847991566947,0.432437218633783,0.434023763434589,0.435607620680555,0.437188785141712,0.438767251646879,0.440343015083603,0.4419160703981,0.443486412595196,0.445054036738258,0.446618937949129,0.448181111408064,0.44974055235365,0.451297256082741,0.452851217950381,0.454402433369723,0.455950897811955,0.457496606806213,0.459039555939502,0.460579740856608,0.46211715726001,0.463651800909792,0.465183667623549,0.466712753276295,0.468239053800366,0.469762565185323,0.471283283477849,0.472801204781655,0.474316325257367,0.475828641122426,0.477338148650979,0.478844844173772,0.480348724078033,0.481849784807364,0.483348022861626,0.484843434796818,0.486336017224962,0.487825766813984,0.489312680287587,0.49079675442513,0.492277986061502,0.493756372086997,0.49523190944718,0.496704595142759,0.498174426229455,0.499641399817862,0.501105513073318,0.50256676321576,0.504025147519595,0.505480663313547,0.506933307980529,0.508383078957485,0.509829973735257,0.51127398985843,0.512715124925187,0.514153376587162,0.515588742549281,0.517021220569618,0.518450808459236,0.51987750408203,0.521301305354577,0.522722210245969,0.524140216777661,0.525555323023303,0.526967527108585,0.528376827211066,0.529783221560014,0.531186708436238,0.532587286171919,0.533984953150446,0.53537970780624,0.536771548624585,0.538160474141456,0.539546482943348,0.540929573667095,0.542309744999699,0.543686995678149,0.545061324489249,0.546432730269431,0.547801211904578,0.549166768329847,0.550529398529476,0.551889101536611,0.553245876433114,0.554599722349382,0.555950638464158,0.557298624004344,0.558643678244811,0.559985800508214,0.561324990164794,0.562661246632196,0.563994569375268,0.565324957905875,0.5666524117827,0.56797693061105,0.569298514042665,0.570617161775516,0.571932873553609,0.57324564916679,0.574555488450542,0.575862391285789,0.577166357598694,0.578467387360458,0.579765480587119,0.58106063733935,0.582352857722253,0.58364214188516,0.584928490021426,0.586211902368224,0.587492379206339,0.588769920859965,0.590044527696493,0.591316200126308,0.592584938602582,0.59385074362106,0.595113615719856,0.596373555479242,0.59763056352144,0.598884640510408,0.60013578715163,0.601384004191909,0.60262929241915,0.60387165266215,0.605111085790387,0.606347592713803,0.607581174382596,0.608811831787002,0.610039565957082,0.611264377962511,0.612486268912356,0.613705239954871,0.614921292277271,0.616134427105526,0.61734464570414,0.618551949375933,0.619756339461831,0.620957817340645,0.622156384428855,0.623352042180394,0.624544792086429,0.625734635675147,0.626921574511533,0.628105610197157,0.629286744369952,0.630464978704,0.631640314909311,0.632812754731608,0.633982299952103,0.635148952387287,0.636312713888705,0.63747358634274,0.638631571670394,0.639786671827072,0.64093888880236,0.642088224619809,0.643234681336715,0.644378261043901,0.6455189658655,0.646656797958734,0.647791759513698,0.648923852753141,0.650053079932248,0.65117944333842,0.652302945291058,0.653423588141347,0.654541374272032,0.655656306097209,0.656768386062097,0.657877616642831,0.658984000346239,0.660087539709625,0.661188237300554,0.662286095716634,0.663381117585301,0.664473305563602,0.665562662337977,0.666649190624047,0.667732893166395,0.668813772738353,0.669891832141785,0.670967074206874,0.672039501791906,0.673109117783056,0.674175925094176,0.675239926666578,0.676301125468823,0.677359524496508,0.67841512677205,0.679467935344479,0.680517953289222,0.681565183707893,0.68260962972808,0.683651294503137,0.68469018121197,0.685726293058829,0.686759633273098,0.687790205109085,0.688818011845814,0.689843056786813,0.690865343259912,0.691884874617029,0.692901654233968,0.693915685510207,0.694926971868697,0.695935516755652,0.696941323640343,0.697944396014898,0.698944737394093,0.69994235131515,0.700937241337531,0.701929411042739,0.702918864034111,0.703905603936621,0.704889634396673,0.705870959081904,0.706849581680983,0.707825505903409,0.708798735479313,0.70976927415926,0.71073712571405,0.711702293934519,0.712664782631345,0.713624595634848,0.714581736794795,0.715536209980207,0.716488019079162,0.717437167998599,0.718383660664127,0.719327501019834,0.720268693028088,0.721207240669352,0.722143147941989,0.723076418862071,0.724007057463193,0.724935067796278,0.725860453929394,0.726783219947561,0.727703369952568,0.728620908062782,0.729535838412964,0.730448165154086,0.731357892453142,0.732265024492964,0.733169565472043,0.734071519604342,0.734970891119113,0.735867684260722,0.73676190328846,0.737653552476369,0.738542636113059,0.739429158501533,0.740313123959004,0.741194536816722,0.742073401419795,0.742949722127014,0.743823503310678,0.744694749356419,0.745563464663028,0.746429653642282,0.747293320718773,0.748154470329735,0.749013106924873,0.749869234966193,0.750722858927833,0.751573983295893,0.752422612568271,0.753268751254489,0.754112403875532,0.754953574963682,0.755792269062347,0.756628490725906,0.757462244519537,0.758293535019059,0.759122366810768,0.759948744491277,0.760772672667355,0.761594155955765,0.762413198983108,0.763229806385665,0.764043982809235,0.764855732908982,0.76566506134928,0.766471972803554,0.767276471954126,0.768078563492067,0.768878252117034,0.769675542537127,0.770470439468733,0.771262947636375,0.772053071772565,0.772840816617652,0.773626186919675,0.774409187434214,0.775189822924245,0.775968098159993,0.776744017918786,0.777517586984914,0.778288810149478,0.779057692210255,0.77982423797155,0.780588452244059,0.781350339844722,0.782109905596592,0.782867154328688,0.783622090875859,0.78437472007865,0.78512504678316,0.785873075840908,0.786618812108698,0.787362260448485,0.788103425727241,0.788842312816819,0.789578926593827,0.790313271939491,0.791045353739526,0.791775176884008,0.792502746267241,0.793228066787633,0.793951143347566,0.794671980853269,0.795390584214694,0.796106958345387,0.796821108162368,0.797533038586004,0.798242754539887,0.798950260950712,0.799655562748155,0.800358664864754,0.801059572235786,0.801758289799151,0.802454822495251,0.803149175266875,0.80384135305908,0.804531360819074,0.805219203496104,0.80590488604134,0.806588413407757,0.807269790550029,0.807949022424413,0.808626113988634,0.809301070201781,0.809973896024192,0.810644596417347,0.811313176343756,0.811979640766856,0.812643994650899,0.813306242960849,0.813966390662276,0.814624442721248,0.81528040410423,0.81593427977798,0.816586074709444,0.817235793865657,0.81788344221364,0.818529024720298,0.819172546352324,0.819814012076096,0.820453426857582,0.821090795662239,0.821726123454917,0.822359415199765,0.822990675860132,0.823619910398474,0.824247123776262,0.824872320953883,0.825495506890551,0.826116686544217,0.826735864871471,0.82735304682746,0.827968237365789,0.828581441438439,0.829192663995675,0.82980190998596,0.830409184355863,0.831014492049982,0.831617838010846,0.83221922717884,0.832818664492117,0.833416154886512,0.834011703295462,0.834605314649922,0.835196993878285,0.835786745906298,0.836374575656985,0.836960488050562,0.837544488004366,0.838126580432769,0.838706770247104,0.839285062355586,0.839861461663238,0.840435973071814,0.841008601479722,0.841579351781951,0.84214822887,0.842715237631797,0.843280382951636,0.843843669710098,0.844405102783982,0.844964687046235,0.84552242736588,0.846078328607948,0.84663239563341,0.847184633299106,0.847735046457681,0.848283639957513,0.848830418642653,0.849375387352753,0.849918550923006,0.850459914184077,0.850999481962044,0.851537259078328,0.852073250349638,0.852607460587903,0.853139894600212,0.853670557188753,0.854199453150756,0.854726587278426,0.855251964358891,0.855775589174139,0.856297466500961,0.856817601110895,0.857335997770166,0.857852661239633,0.85836759627473,0.858880807625414,0.859392300036108,0.859902078245647,0.860410146987225,0.860916510988344,0.861421174970757,0.86192414365042,0.862425421737439,0.86292501393602,0.863422924944416,0.863919159454882,0.864413722153622,0.864906617720742,0.8653978508302,0.865887426149761,0.866375348340948,0.866861622058997,0.867346251952808,0.867829242664903,0.868310598831378,0.868790325081861,0.869268426039467,0.869744906320753,0.870219770535676,0.870693023287552,0.871164669173012,0.871634712781961,0.872103158697536,0.872570011496069,0.873035275747043,0.873498956013054,0.87396105684977,0.874421582805897,0.874880538423137,0.87533792823615,0.87579375677252,0.876248028552715,0.876700748090051,0.87715191989066,0.877601548453449,0.87804963827007,0.878496193824883,0.878941219594922,0.879384720049862,0.879826699651985,0.88026716285615,0.880706114109757,0.881143557852719,0.881579498517428,0.882013940528724,0.882446888303866,0.882878346252502,0.883308318776638,0.883736810270609,0.884163825121051,0.884589367706873,0.885013442399228,0.885436053561486,0.885857205549205,0.886276902710107,0.886695149384052,0.887111949903009,0.887527308591033,0.887941229764237,0.888353717730771,0.888764776790797,0.889174411236462,0.889582625351876,0.889989423413092,0.890394809688077,0.890798788436695,0.891201363910683,0.891602540353629,0.89200232200095,0.892400713079872,0.892797717809412,0.893193340400352,0.893587585055224,0.893980455968289,0.894371957325518,0.894762093304573,0.895150868074786,0.895538285797149,0.895924350624285,0.89630906670044,0.896692438161463,0.897074469134785,0.897455163739411,0.897834526085895,0.898212560276333,0.898589270404339,0.898964660555038,0.899338734805046,0.899711497222458,0.900082951866831,0.900453102789175,0.900821954031937,0.901189509628985,0.901555773605603,0.901920749978469,0.90228444275565,0.902646855936588,0.903007993512086,0.903367859464301,0.90372645776673,0.9040837923842,0.904439867272859,0.904794686380162,0.905148253644866,0.90550057299702,0.905851648357952,0.906201483640262,0.906550082747815,0.906897449575731,0.907243588010378,0.907588501929361,0.907932195201519,0.908274671686916,0.908615935236831,0.908955989693756,0.909294838891387,0.909632486654618,0.909968936799535,0.910304193133411,0.9106382594547,0.91097113955303,0.911302837209203,0.911633356195186,0.911962700274107,0.912290873200253,0.912617878719064,0.912943720567129,0.913268402472186,0.913591928153115,0.913914301319936,0.914235525673806,0.914555604907019,0.914874542703,0.915192342736307,0.915509008672623,0.915824544168762,0.916138952872663,0.916452238423388,0.916764404451124,0.917075454577181,0.917385392413991,0.91769422156511,0.918001945625214,0.918308568180101,0.918614092806694,0.918918523073036,0.919221862538297,0.919524114752768,0.919825283257869,0.920125371586147,0.920424383261275,0.92072232179806,0.921019190702439,0.921314993471484,0.921609733593404,0.921903414547547,0.922196039804405,0.92248761282561,0.922778137063948,0.923067615963351,0.923356052958909,0.923643451476867,0.923929814934635,0.924215146740785,0.924499450295063,0.924782728988387,0.925064986202853,0.925346225311741,0.92562644967952,0.92590566266185,0.92618386760559,0.926461067848803,0.926737266720759,0.927012467541944,0.927286673624065,0.927559888270051,0.927832114774066,0.928103356421513,0.928373616489039,0.928642898244539,0.92891120494717,0.929178539847352,0.929444906186777,0.929710307198414,0.929974746106519,0.930238226126641,0.930500750465632,0.930762322321648,0.931022944884166,0.931282621333982,0.931541354843229,0.931799148575377,0.932056005685247,0.932311929319015,0.932566922614224,0.932820988699792,0.933074130696019,0.933326351714596,0.933577654858619,0.933828043222592,0.934077519892437,0.93432608794551,0.9345737504506,0.934820510467949,0.935066371049256,0.935311335237686,0.935555406067884,0.935798586565984,0.936040879749615,0.936282288627919,0.936522816201554,0.936762465462709,0.937001239395113,0.937239140974047,0.937476173166352,0.937712338930443,0.937947641216321,0.938182082965578,0.938415667111415,0.938648396578652,0.938880274283734,0.939111303134751,0.939341486031442,0.939570825865212,0.939799325519141,0.940026987867997,0.940253815778247,0.940479812108072,0.940704979707373,0.94092932141779,0.941152840072712,0.941375538497287,0.941597419508437,0.941818485914871,0.942038740517094,0.942258186107424,0.942476825470004,0.942694661380813,0.942911696607679,0.943127933910295,0.943343376040227,0.943558025740934,0.943771885747774,0.943984958788024,0.944197247580887,0.94440875483751,0.944619483260997,0.94482943554642,0.945038614380836,0.945247022443297,0.945454662404868,0.945661536928638,0.945867648669733,0.946073000275333,0.946277594384684,0.946481433629114,0.946684520632043,0.946886858009002,0.947088448367644,0.947289294307761,0.947489398421294,0.947688763292354,0.94788739149723,0.948085285604406,0.948282448174578,0.948478881760663,0.94867458890782,0.948869572153461,0.949063834027265,0.949257377051196,0.949450203739515,0.949642316598796,0.949833718127943,0.950024410818199,0.950214397153169,0.950403679608829,0.950592260653542,0.950780142748076,0.950967328345618,0.951153819891786,0.951339619824649,0.95152473057474,0.95170915456507,0.951892894211148,0.952075951920989,0.952258330095138,0.952440031126679,0.952621057401251,0.952801411297069,0.952981095184934,0.953160111428249,0.953338462383039,0.953516150397961,0.953693177814323,0.9538695469661,0.954045260179949,0.954220319775222,0.954394728063988,0.954568487351042,0.954741599933926,0.954914068102941,0.955085894141168,0.955257080324477,0.955427628921549,0.955597542193889,0.955766822395841,0.955935471774608,0.956103492570264,0.956270887015773,0.956437657337,0.956603805752736,0.956769334474705,0.956934245707584,0.957098541649021,0.957262224489648,0.957425296413098,0.957587759596022,0.957749616208104,0.957910868412078,0.958071518363745,0.958231568211987,0.958391020098785,0.958549876159235,0.958708138521563,0.958865809307143,0.959022890630512,0.959179384599388,0.959335293314683,0.959490618870522,0.95964536335426,0.959799528846496,0.95995311742109,0.960106131145179,0.960258572079196,0.960410442276882,0.960561743785307,0.960712478644881,0.960862648889375,0.961012256545937,0.961161303635103,0.961309792170821,0.961457724160462,0.96160510160484,0.961751926498222,0.961898200828354,0.962043926576469,0.962189105717307,0.962333740219131,0.962477832043743,0.962621383146502,0.962764395476337,0.962906870975765,0.963048811580911,0.963190219221517,0.963331095820963,0.963471443296286,0.963611263558189,0.963750558511063,0.963889330053001};
static DRAM_ATTR float kernel_2s0[21] = {0.000001,0.000009,0.000075,0.000476,0.002359,0.009135,0.027646,0.065407,0.120983,0.174973,0.197872,0.174973,0.120983,0.065407,0.027646,0.009135,0.002359,0.000476,0.000075,0.000009,0.000001}; 
static DRAM_ATTR float kernel_3s2[21] = {0.000959,0.002419,0.005532,0.011479,0.02161,0.036908 ,0.05719 , 0.0804 ,0.102547,0.118665,0.124582,0.118665,0.102547,0.0804  ,0.05719 ,0.036908,0.02161 ,0.011479,0.005532,0.002419,0.000959};
static DRAM_ATTR float kernel_0s6[7]  = {0.000032,0.008166,0.203658,0.576289,0.203658,0.008166,0.000032};
static DRAM_ATTR float kernel_1s0[7]  = {0.00598,0.060626,0.241843,0.383103,0.241843,0.060626,0.00598};


inline static float tanhlookup(float v)
{
  if (v>=2)
    return 1;    
  if (v<=-2)
    return -1;
  if (v<0)
    return (0-tanhlookuptable[(uint16_t)((0-v)*512)]);    
  return (tanhlookuptable[(uint16_t)(v*512)]);
}

static float scalelin(float scale, float min, float max)
{
  return min+(max-min)*scale;
}

static float scalelog(float scale, float min, float max)
{
  return exp(log(min) + (log(max)-log(min))*scale);
}

inline static uint8_t bw_set(uint8_t *bw, uint32_t pos, uint8_t v)
{
  uint8_t shift=(pos%4)*2;
  pos=pos/4;
  bw[pos]=(bw[pos] & (~(0b11 << shift))) | ((v & 0b11) << shift);
}
inline static uint8_t bw_get(uint8_t *bw, uint32_t pos)
{ 
  return (bw[pos/4] >> ((pos%4)*2)) & 0b11;
}

inline static uint8_t done_set(uint8_t *done, uint32_t pos, uint8_t v)
{
  uint8_t shift=pos%8;
  pos=pos/8;
  done[pos]=(done[pos] & (~(0b1 << shift))) | ((v & 0b1) << shift);
}
inline static uint8_t done_get(uint8_t *done, uint32_t pos)
{ 
  return (done[pos/8] >> (pos%8)) & 0b1;
}


//https://lodev.org/cgtutor/floodfill.html
//The scanline floodfill algorithm using stack instead of recursion, more robust
static void floodFillScanlineStack(uint16_t w, uint16_t h, uint8_t *bw, uint32_t *stack, uint16_t x, uint16_t y)
{  
  uint32_t pointer =0;
  stack[pointer++] = x+y*w;

  while(pointer>0)
  {
    uint32_t c= stack[--pointer];
    uint16_t x=c%w;
    uint16_t y=(c/w)|0;
    int16_t x1 = x;
    while(x1 >= 0 && bw_get(bw,x1+y*w) == 1) x1--;
    //8 Way:
    if(x1 > 0 && y > 0 && bw_get(bw,x1+(y-1)*w) == 1)
    {
      stack[pointer++] =x1+(y - 1)*w;
    }
    if(x1 > 0 && y < h-1 && bw_get(bw,x1+(y+1)*w) == 1)
    {
      stack[pointer++]=x1+(y + 1)*w;
    }
    x1++;
    uint8_t spanAbove = 0;
    uint8_t spanBelow = 0;
    while(x1 < w && bw_get(bw,x1+y*w) == 1)
    {
      bw_set(bw,x1+y*w,2);
      if(!spanAbove && y > 0 && bw_get(bw,x1+(y-1)*w) == 1)
      {
        stack[pointer++]=x1+(y - 1)*w;
        spanAbove = 1;
      }
      else if(spanAbove && y > 0 &&  bw_get(bw,x1+(y-1)*w) != 1)
      {
        spanAbove = 0;
      }
      if(!spanBelow && y < h - 1 &&  bw_get(bw,x1+(y+1)*w) == 1 )
      {
        stack[pointer++]=x1+(y + 1)*w;
        spanBelow = 1;
      }
      else if(spanBelow && y < h - 1 && bw_get(bw,x1+(y+1)*w) != 1)
      {
        spanBelow = 0;
      }
      x1++;
    }
    //8Way:
    if(x1 < w && y > 0 && bw_get(bw,x1+(y-1)*w) == 1)
    {
      stack[pointer++]=x1+(y - 1)*w;
    }
    if(x1 < w && y < h-1 && bw_get(bw,x1+(y+1)*w) == 1)
    {
      stack[pointer++]=x1+(y + 1)*w;
    } 
  }
}

static s_line searchAndConnect(uint16_t w, uint16_t h, uint8_t *bw)
{
  s_line line; 
  
  //marke new boardes
  for(uint16_t y=1;y<h-1;y++)
  {
    for(uint16_t x=1;x<w-1;x++)
    {
      if(bw_get(bw,x+y*w)==0)
      {
        if( bw_get(bw,(x+1)+y*w)==2 || bw_get(bw,x+(y+1)*w)==2 || 
            bw_get(bw,(x-1)+y*w)==2 || bw_get(bw,x+(y-1)*w)==2    )
        {
          bw_set(bw,x+y*w,3);
        }
      }
    }
  }

  for (uint16_t r=0;;r++)
  {
    for(uint16_t y=0;y<h;y++)
    {
      for(uint16_t x=0;x<w;x++)
      {
        if(bw_get(bw,x+y*w)==3)
        {   
          int16_t rx = r;
          int16_t ry = 0;
          int16_t rd = 1 - r;
          do 
          {
            if(rx<w && ry<h)
            {
              for(uint8_t c=0;c<8;c++)
              {
                int16_t dx, dy;
                if(c%2)
                {
                  dx=rx;
                  dy=ry;
                }
                else
                {
                  dx=ry;
                  dy=rx;                  
                }
                if((c/2)%2)
                {
                  dx=0-dx;
                }
                if((c/4)%2)
                {
                  dy=0-dy;
                }
                if((x+dx)>=0 && (x+dx)<w && 
                   (y+dy)>=0 && (y+dy)<h && 
                    bw_get(bw,x+dx+(y+dy)*w)==1 )
                {
                  line.xs=x;
                  line.ys=y;
                  line.xe=x+dx;
                  line.ye=y+dy;
                  return line;
                }                     
              }
            }
            ry = ry + 1;
            if (rd < 0)
            {
                rd = rd + 2*ry + 1;          
            }
            else
            {
                rx = rx - 1;
                rd = rd + 2*(ry-rx) + 1;
            }
          } while(rx > ry);          
        }
      }
    }
  }
}

static void drawLine(uint16_t w, uint16_t h, uint8_t *bw, s_line line)
{
  uint16_t x0=line.xs;
  uint16_t y0=line.ys;
  uint16_t x1=line.xe;
  uint16_t y1=line.ye;
  int16_t dx =  abs(x1-x0);
  int8_t sx = x0<x1 ? 1 : -1;
  int16_t dy = -abs(y1-y0);
  int8_t sy = y0<y1 ? 1 : -1;
  int16_t err = dx+dy;  /* error value e_xy */
  for(;;)
  {   /* loop */
    bw_set(bw,x0+y0*w,2);
    if (x0==x1 && y0==y1) 
    {
      break;       
    }
    int16_t e2 = 2*err;
    if (e2 >= dy) 
    {
      err += dy; /* e_xy+e_x > 0 */
      x0 += sx;
    }
    if (e2 <= dx)
    { /* e_xy+e_y < 0 */
      err += dx;
      y0 += sy;
    }
  }
}

uint8_t convert_RGB2Grayscale(uint16_t rgb_w, uint16_t rgb_h, uint8_t *rgb, uint16_t gray_w, uint16_t gray_h, uint8_t *gray)
{
  //we need to rotate the image!! 
  
  uint16_t offsetx = (rgb_h -gray_w)/2;
  uint16_t offsety = (rgb_w -gray_h)/2;
  
  for (uint16_t x=0; x<gray_w;x++)
  {    
    for (uint16_t y=0; y<gray_h;y++)
    {
      uint32_t i=(x+offsetx)*rgb_w+y+offsety;
      gray[x+y*gray_w]=(uint8_t)(rgb[i*3+0]*0.299+rgb[i*3+1]*0.587+rgb[i*3+2]*0.114);
    }  
  }
  return 1;
}

uint8_t convert_XDOG_init(uint16_t w, uint16_t h, convert_statuscallback_t statuscb, uint8_t *gray, uint16_t *buffer1, uint16_t *buffer2)
{
  uint8_t kernel_size;
  uint8_t kernel_half;
  float *kernel[2];
  if(w>100)
  {
    kernel_size=21;
    kernel_half=10;  
    kernel[0] = kernel_2s0;
    kernel[1] = kernel_3s2;
  }
  else
  {
    kernel_size=7;
    kernel_half=3;  
    kernel[0] = kernel_0s6;
    kernel[1] = kernel_1s0;
 }
  
  uint16_t * gaus[2] ={buffer1,buffer2};
  
  uint16_t convbuf[MAX(w,h)+kernel_half*2]; //~2kB should be ok to place on stack 

  if(statuscb!=NULL) 
  {
    if(statuscb("filter",0))
    {
      return 0;
    } 
  }
  for(uint8_t g=0;g<2;g++)
  {
    for(uint32_t ls=0;ls<w*h;ls+=w)
    {
      //fill buffer            
      uint16_t v=gray[ls]*256;
      for(uint16_t b=0;b<kernel_half;b++){
        convbuf[b]=v;
      }            
      for(uint16_t b=0;b<w;b++){
        convbuf[kernel_half+b]=gray[ls+b]*256;
      }
      v=gray[ls+w-1];
      for(uint16_t b=0;b<kernel_half;b++){
        convbuf[kernel_half+w+b]=v;
      }
      //convolution
      for(uint16_t p=0;p<w;p++){
        float sum=0;
        for(uint16_t k=0;k<kernel_size;k++){
          sum+=convbuf[p+k]*kernel[g][k];
        }
        gaus[g][ls+p]=sum;
      } 
      if(statuscb!=NULL && (ls/w)%(h/20)==0)
      {
        if(statuscb("filter",25*ls/(w*h)+50*g))
        {
          return 0;
        }
      } 
    }
    
    for(uint16_t rs=0;rs<w;rs+=1)
    {
      //fill buffer
      uint16_t v=gaus[g][rs];
      for(uint16_t b=0;b<kernel_half;b++){
        convbuf[b]=v;
      }
      for(uint16_t b=0;b<h;b++){
        convbuf[kernel_half+b]=gaus[g][rs+b*w];
      }
      v=gaus[g][rs+(h-1)*w];
      for(uint16_t b=0;b<kernel_half;b++){
        convbuf[kernel_half+h+b]=v;
      }
      //convolution
      for(uint16_t p=0;p<h;p++){
        float sum=0;
        for(uint16_t k=0;k<kernel_size;k++){
          sum+=convbuf[p+k]*kernel[g][k];
        }
        gaus[g][rs+p*w]=sum;
      }          
      if(statuscb!=NULL && rs%(w/20)==0) 
      {
        if(statuscb("filter",25*rs/w+25+50*g))
        {
          return 0;
        }
      }        
    }
  }
  if(statuscb!=NULL) 
  {
    if(statuscb("filter",100))
    {
      return 0;
    } 
  }  
  return 1;
}

uint8_t convert_XDOG(uint16_t w, uint16_t h, float gamma, float phi, uint16_t *buffer1, uint16_t *buffer2, uint8_t *bw)
{
  uint16_t * gaus[2] ={buffer1,buffer2};
  gamma=scalelog(gamma,0.5,0.99);
  phi=scalelog(phi,500,1);
  
  //calc mean:
  float mean=0;
  for (uint32_t i=0; i<w*h;i++){
    float v = (gaus[0][i]-(gamma*gaus[1][i]))/(256*256.0);
    if(v < -0.1){
      v=1.0;
    }
    else{
      v=1.0+tanhlookup(phi*v);
    }
    mean+=v;
  }        
  mean=mean/(w*h);

  for (uint32_t i=0; i<w*h;i++){
    float v = (gaus[0][i]-(gamma*gaus[1][i]))/(256*256.0);
    if(v < -0.1){
      v=1.0;
    }
    else{
      v=1.0+tanhlookup(phi*v);
    }
    if(v < mean){
      bw_set(bw,i,1);
    }
    else{
      bw_set(bw,i,0);
    }
    
  }
  return 1;  
}

uint8_t convert_XDOG_o(uint16_t w, uint16_t h, float gamma, float phi, uint16_t *buffer1, uint16_t *buffer2,uint8_t scale, uint8_t * display)
{
  uint16_t * gaus[2] ={buffer1,buffer2};
  gamma=scalelog(gamma,0.5,0.99);
  phi=scalelog(phi,500,1);

  for (uint32_t i=0; i<(w/scale)*(h/scale);i++){
     ((float *)display)[i]=0; 
  }  
  //calc mean:
  uint32_t p=0;
  float mean=0;
  for (uint16_t y=0; y<h;y++){
    for (uint16_t x=0; x<w;x++){
      uint32_t pos = x+y*w;
      float v = (gaus[0][pos]-(gamma*gaus[1][pos]))/(256*256.0);
      if(v < -0.1){
        v=1.0;
      }
      else{
        v=1.0+tanhlookup(phi*v);
      }
      mean+=v;
      
      ((float *)display)[x/scale +y/scale*(w/scale)]+=v; 
    }
  }        
  mean=mean/(w*h);

  for (uint32_t i=0; i<(w/scale)*(h/scale);i++){
    if((((float *)display)[i])/(scale*scale) < mean){
      display[i]=1;
    }
    else{
      display[i]=0;
    }
  }
  return 1;  
}


uint8_t convert_connect(uint16_t w, uint16_t h, convert_statuscallback_t statuscb, uint8_t *bw, uint32_t *stack)
{
  if(statuscb!=NULL) 
  {
    if(statuscb("connecting",0))
    {
      return 0;
    } 
  }
  
  //we need a Line to start from:
  for(uint16_t i=0;i<w;i++)
  {
    bw_set(bw,i,1);
  }
  for(uint16_t i=0;i<w;i++)
  {
    bw_set(bw,i+(h-1)*w,1);
  }
  for(uint16_t i=0;i<h;i++)
  {
    bw_set(bw,i*w,1);
  }
  for(uint16_t i=0;i<h;i++)
  {
    bw_set(bw,w-1+i*w,1);
  }
  
  floodFillScanlineStack(w,h,bw,stack,0,h-1);   
            
  uint32_t totalBlackPixel=0;
  for(uint32_t i=0;i<w*h;i++)
  {
    if(bw_get(bw,i)==1)
    {
      totalBlackPixel++;
    }
  }
  
  for(;;)
  {
    //test if there is stell something left:
    uint32_t blackPixel=0;
    for(uint32_t i=0;i<w*h;i++)
    {
      if(bw_get(bw,i)==1)
      {
        blackPixel++;
      }
    }
    if(blackPixel==0)
    {
      //Done
      break;
    } 
    if(statuscb!=NULL) 
    {
      if(statuscb("connecting",pow(101,(totalBlackPixel-blackPixel)/(float)totalBlackPixel)-1))
      {
        return 0;
      } 
    }
       
    s_line line=searchAndConnect(w,h,bw); 

    drawLine(w,h,bw,line);
    floodFillScanlineStack(w,h,bw,stack,line.xe,line.ye);  
  
  }
  
  //remove boarder
  for(uint32_t i=0;i<w*h;i++)
  {
    if(bw_get(bw,i)==3)
    {
        bw_set(bw,i,0);
    }
  }
  
  if(statuscb!=NULL) 
  {
    if(statuscb("connecting",100))
    {
      return 0;
    } 
  }
  return 1;
}


uint8_t convert_etch(uint16_t w, uint16_t h, convert_statuscallback_t statuscb,  convert_movecallback_t movecb, uint8_t *bw, uint8_t *done, uint16_t * cost, uint32_t *discoverd, uint32_t discoverd_length)
{
  if(statuscb!=NULL) 
  {
    if(statuscb("etching",0))
    {
      return 0;
    } 
  }
  
  uint32_t totalRedPixel=0;
  for(uint32_t i=0;i<w*h;i++)
  {
    if(bw_get(bw,i)==2)
    {
      totalRedPixel++;
    }
  }
  //start point
  uint16_t cx=0;
  uint16_t cy=h-1;
  movecb(cx,cy);

  for(;;)
  {
    //search for the longest line:
    uint16_t ndx=1;
    uint16_t ndy=0;
    uint16_t nlength=0;
    for (uint8_t dir=0;dir<4;dir++)
    {
      uint16_t dx,dy;
      switch(dir)
      {
        case 0:
          dx=1;
          dy=0;
          break;
        case 1:
          dx=0;
          dy=1;
          break;
        case 2:
          dx=-1;
          dy=0;
          break;
        case 3:
          dx=0;
          dy=-1;
          break;
      }
      uint16_t tx=cx;
      uint16_t ty=cy;
      uint16_t length=0;
      while(tx>=0 && ty>=0 && tx<w && ty<h && bw_get(bw,tx+ty*w)==2)
      {
        length++;
        tx+=dx;
        ty+=dy;
      }
      if(length>nlength)
      {
        ndx=dx;
        ndy=dy;
        nlength=length;
      }                
    }
    
    //marke line done!
    for(uint16_t i=0;i<nlength;i++)
    {
      bw_set(bw,cx+cy*w,3);
      if(i<nlength-1)
      {
        cx+=ndx;
        cy+=ndy;
      }
    }

    //generate G code:
    movecb(cx,cy);
    
    //find next empty spot => breadth first search
    uint32_t readpointer=0;
    uint32_t writepointer=0;            
    uint16_t ax=cx;
    uint16_t ay=cy;
    uint32_t current=ax+ay*w; 
    for (uint32_t i=0;i<w*h;i++)
    {
      done_set(done,i,0); // need to be cleared!      
    }
    discoverd[writepointer++]=current;
    cost[current]=0;
    done_set(done,current,1);
    while (readpointer!=writepointer)
    {
      //remove first element:
      current=discoverd[readpointer];
      ax= current%w; 
      ay= (current/w)|0;

      if(bw_get(bw,current)==2)
      {
        //found next spot to echt
        break;
      }
      readpointer=(readpointer+1)%discoverd_length;    
      
      //process
      uint16_t cmin=cost[current];
      for(uint8_t n=0;n<9;n++)
      {
        int8_t dx=n%3==0?1:((n%3==1)?0:-1);
        int8_t dy=(n/3)%3==0?1:(((n/3)%3==1)?0:-1);
        uint32_t next=ax+dx +(ay+dy)*w;
        if (ax+dx>=0 && ay+dy>=0 && ax+dx<w && ay+dy<h && done_get(done,next))
        {
          uint16_t c=cost[next]+((dx!=0 && dy!=0)?14:10);
          if(cmin>c)
            cmin=c;
        }
      }
      cost[current]=cmin;
      
      for(uint8_t n=0;n<9;n++)
      {
        int8_t dx=n%3==0?1:((n%3==1)?0:-1);
        int8_t dy=(n/3)%3==0?1:(((n/3)%3==1)?0:-1);
        uint32_t next=ax+dx+(ay+dy)*w;
        if (ax+dx>=0 && ay+dy>=0 && ax+dx<w && ay+dy<h && 
            done_get(done,next)==0 && bw_get(bw,next)!=0)
        {
          cost[next]=cost[current]+100; //Higher cost not visited yet!
          done_set(done,next,1);
          discoverd[writepointer]=next;                  
          writepointer=(writepointer+1)%discoverd_length;          
        }
      }
    }
    if(readpointer==writepointer)
    {
      //done! all is etched
      break;
    }
    
    //Trace back;
    discoverd[0]=current;
    int16_t i=0;
    for(;discoverd[i]!=cx+cy*w;i++)
    {
      uint16_t ax=discoverd[i]%w; 
      uint16_t ay=discoverd[i]/w;
      uint16_t c=cost[discoverd[i]];
      uint8_t found=0;
      for(uint8_t n=0;n<9;n++)
      {
        int8_t dx=n%3==0?1:((n%3==1)?0:-1);
        int8_t dy=(n/3)%3==0?1:(((n/3)%3==1)?0:-1);
        uint32_t next=ax+dx+(ay+dy)*w;
        if ((dx!=0 || dy!=0) && ax+dx>=0 && ay+dy>=0 && 
                                ax+dx<w  && ay+dy<h  && 
            done_get(done,next)                         )
        {
          if(c>cost[next])
          {
            c=cost[next];
            discoverd[i+1]=next;
            found=1;
          }
        }
      }
    }

    int8_t ldx=0;
    int8_t ldy=0;
    for(;i>=0;i--)
    {
      uint16_t x=discoverd[i]%w;
      uint16_t y=discoverd[i]/w;
      uint16_t nx=discoverd[i+1]%w;
      uint16_t ny=discoverd[i+1]/w;
      int8_t dx=x-nx;
      int8_t dy=y-ny;
      if(ldx!=dx || ldy!=dy)
      {
        //generate G code:
        movecb(x,y);
        ldx=dx;
        ldy=dy;
      }
    }  
    
    cx=discoverd[0]%w;
    cy=discoverd[0]/w;
    movecb(cx,cy);
    
    uint32_t greenPixel=0;
    for(uint32_t i=0;i<w*h;i++)
    {
      if(bw_get(bw,i)==3)
      {
        greenPixel++;
      }
    }
    if(statuscb!=NULL) 
    {
      if(statuscb("etching",100*greenPixel/totalRedPixel))
      {
        return 0;
      } 
    }    
  }
  if(statuscb!=NULL) 
  {
    if(statuscb("etching",100))
    {
      return 0;
    } 
  }
  return 1;  
}


